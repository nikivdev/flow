version = 1
name = "flow"

[agents]
review-agent = "nikivdev:review-agent"

[flow]
primary_task = "deploy"
deploy_task = "deploy"
release_task = "release"

[options]
# Enable gitedit.dev mirroring for commits
gitedit_mirror = true
# Enable gitedit.dev mirroring for commitWithCheck
commit_with_check_gitedit_mirror = true
gitedit_url = "https://gitedit.dev"
commit_with_check_review_url = "http://100.114.156.47:3000/review"

[commit]
queue = true

[jj]
default_branch = "main"
remote = "origin"
auto_track = true
review_prefix = "review"

[release]
# Default release provider for `f release`.
default = "registry"
# Use calendar versioning for registry releases (YYYY.M.D).
versioning = "calver"
# Set these to your release host values.
domain = "flow.yourdomain.com"
base_url = "https://flow.yourdomain.com"
root = "/var/www/flow"
caddyfile = "/etc/caddy/Caddyfile"
readme = "readme.md"

[release.registry]
url = "https://myflow.sh"
package = "flow"
bins = ["f", "lin"]
default_bin = "f"
token_env = "FLOW_REGISTRY_TOKEN"
latest = true

[flox]
[flox.install]
cargo.pkg-path = "cargo"
eza.pkg-path = "eza"

[[tasks]]
name = "setup"
command = "cargo check"
description = "Compile the workspace to make sure the toolchain works"
activate_on_cd_to_root = true

[[tasks]]
name = "test"
command = "cargo test"
description = "Run the full test suite for a basic sanity check"

[[tasks]]
name = "which-cargo"
command = "which cargo && cargo --version"
description = "Confirm cargo is coming from the managed toolchain"
dependencies = ["cargo"]

[[tasks]]
name = "test-deps"
command = "tsx tests/deps.ts"
description = "Run the e2e managed-deps test script"

[[tasks]]
name = "dev-hub"
command = "cargo run -- hub start"
description = "Ensure the hub daemon is running locally"

[[tasks]]
name = "deploy-cli-release"
command = "FLOW_PROFILE=release ./scripts/deploy.sh"
description = "Build the CLI/daemon with --release and copy the binary to ~/.local/bin/flow"

[[tasks]]
name = "deploy"
command = "FLOW_PROFILE=release ./scripts/deploy.sh"
description = "Build the CLI/daemon with --release and copy the binary to ~/.local/bin/flow"

[[tasks]]
name = "deploy-traces"
command = "FLOW_PROFILE=release ./scripts/deploy.sh"
description = "Deploy CLI with traces updates (f traces)"

[[tasks]]
name = "deploy-with-hub-reload"
command = "FLOW_PROFILE=release ./scripts/deploy.sh && f hub stop && FLOW_DOCS_FOCUS=1 f hub"
description = "Deploy and restart hub daemons (lin + docs)"

[[tasks]]
name = "release-build"
command = "bash ./scripts/package-release.sh"
description = "Build signed release artifacts into dist/ (set FLOW_VERSION, CODESIGN_IDENTITY env vars as needed)"

[[tasks]]
name = "release"
command = "./scripts/release.sh"
description = "Build darwin/arm64 release, publish to host, update install snippet"

[[tasks]]
name = "release-host-setup"
command = "infra release setup --path ."
description = "Install Caddy and configure a release host (uses infra host set + [release])"

[[tasks]]
name = "release-publish"
command = "bash -c 'tarball=$(ls -t dist/flow_*_darwin_arm64.tar.gz | head -n1) && infra release publish \"$tarball\" --path .'"
description = "Upload the latest darwin/arm64 release tarball to the release host"

[[tasks]]
name = "test-flow-task-tracing"
command = "bun i-run.ts"

[[tasks]]
name = "test-flow-server-tracing"
command = "bun i-server.ts"

[[tasks]]
name = "test-log-server"
command = "bun tests/test_log_server.ts"
description = "Test log ingestion and query endpoints (requires 'f server' running)"

[[tasks]]
name = "test-args"
command = "echo \"arg1=$1 arg2=$2 all=$@\""
description = "Test that task args are passed correctly"

[[tasks]]
name = "clone-test-repo"
command = "git clone https://github.com/nikivdev/flow-testing testing/flow-testing"
description = "Clone the flow-testing repo into testing/"

[[tasks]]
name = "agents"
command = "bash ./scripts/agents-switch.sh $@"
description = "Switch agents.md profile in a repo"
interactive = true

[storage]
provider = "myflow.sh"
env_var = "FLOW_SECRETS_TOKEN" # optional; defaults to this value

[[storage.envs]]
name = "local"
description = "Local development defaults"
variables = [
  { key = "DATABASE_URL", default = "" },
  { key = "OPENAI_API_KEY", default = "" },
  { key = "ANTHROPIC_API_KEY", default = "" },
]

# ============================================================================
# Swarm Demo Tasks - Run with: uv run flow <command> "<task>"
# ============================================================================

[[tasks]]
name = "swarm-single"
command = "uv run flow.py single \"$@\""
description = "Single agent demo"

[[tasks]]
name = "swarm-seq"
command = "uv run flow.py sequential \"$@\""
description = "Sequential workflow (Researcher -> Analyst -> Writer)"

[[tasks]]
name = "swarm-parallel"
command = "uv run flow.py concurrent \"$@\""
description = "Concurrent agents (Optimist, Critic, Pragmatist)"

[[tasks]]
name = "swarm-hier"
command = "uv run flow.py hierarchical \"$@\""
description = "Hierarchical swarm (Director with workers)"

[[tasks]]
name = "swarm-rearrange"
command = "uv run flow.py rearrange \"$@\""
description = "Agent rearrange with custom flow"

[[tasks]]
name = "swarm-chat"
command = "uv run flow.py chat \"$@\""
description = "Group chat discussion"

[[tasks]]
name = "swarm-auto"
command = "uv run flow.py auto \"$@\""
description = "Auto-generate a swarm for a task"

[[tasks]]
name = "pond-build"
command = "bash -c 'cd /Users/nikiv/repos/ghostty-org/ghostty && zig build && zig build -Doptimize=ReleaseFast'"
description = "Build Pond (Ghostty fork) in debug and production modes"

[[tasks]]
name = "pond-debug"
command = "bash -c 'cd /Users/nikiv/repos/ghostty-org/ghostty && zig build -Doptimize=Debug'"
description = "Build Pond (Ghostty fork) in debug mode"

[[tasks]]
name = "linsa-assistant-serve"
command = "bash -c 'cd /Users/nikiv/code/org/linsa/linsa/api/cpp && sh ./run.sh serve'"
description = "Build + run the Linsa C++ assistant proxy server"

[[tasks]]
name = "linsa-assistant-stream"
command = "bash -c 'curl -N -X POST http://127.0.0.1:8788/api/assistant/chat/stream -H \"Content-Type: application/json\" -d \"{\\\"message\\\":\\\"hello\\\"}\"'"
description = "Stream assistant response via SSE from the local proxy"
