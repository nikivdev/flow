version = 1
name = "flow"

[flow]
primary_task = "deploy-cli-release"
release_task = "release"

[options]
# Enable gitedit.dev mirroring for commits
gitedit_mirror = true
# Enable gitedit.dev mirroring for commitWithCheck
commit_with_check_gitedit_mirror = true
gitedit_url = "https://gitedit.dev"
commit_with_check_review_url = "http://100.114.156.47:3000/review"

[release]
# Set these to your release host values.
domain = "flow.yourdomain.com"
base_url = "https://flow.yourdomain.com"
root = "/var/www/flow"
caddyfile = "/etc/caddy/Caddyfile"
readme = "readme.md"

[flox]
[flox.install]
cargo.pkg-path = "cargo"
eza.pkg-path = "eza"

[[tasks]]
name = "setup"
command = "cargo check"
description = "Compile the workspace to make sure the toolchain works"
activate_on_cd_to_root = true

[[tasks]]
name = "test"
command = "cargo test"
description = "Run the full test suite for a basic sanity check"

[[tasks]]
name = "which-cargo"
command = "which cargo && cargo --version"
description = "Confirm cargo is coming from the managed toolchain"
dependencies = ["cargo"]

[[tasks]]
name = "test-deps"
command = "tsx tests/deps.ts"
description = "Run the e2e managed-deps test script"

[[tasks]]
name = "dev-hub"
command = "cargo run -- hub start"
description = "Ensure the hub daemon is running locally"

[[tasks]]
name = "deploy-cli-release"
command = "FLOW_PROFILE=release ./scripts/deploy.sh"
description = "Build the CLI/daemon with --release and copy the binary to ~/.local/bin/flow"

[[tasks]]
name = "release-build"
command = "bash ./scripts/package-release.sh"
description = "Build signed release artifacts into dist/ (set FLOW_VERSION, CODESIGN_IDENTITY env vars as needed)"

[[tasks]]
name = "release"
command = "./scripts/release.sh"
description = "Build darwin/arm64 release, publish to host, update install snippet"

[[tasks]]
name = "release-host-setup"
command = "infra release setup --path ."
description = "Install Caddy and configure a release host (uses infra host set + [release])"

[[tasks]]
name = "release-publish"
command = "bash -c 'tarball=$(ls -t dist/flow_*_darwin_arm64.tar.gz | head -n1) && infra release publish \"$tarball\" --path .'"
description = "Upload the latest darwin/arm64 release tarball to the release host"

[[tasks]]
name = "test-flow-task-tracing"
command = "bun i-run.ts"

[[tasks]]
name = "test-flow-server-tracing"
command = "bun i-server.ts"

[[tasks]]
name = "test-log-server"
command = "bun tests/test_log_server.ts"
description = "Test log ingestion and query endpoints (requires 'f server' running)"

[[tasks]]
name = "test-args"
command = "echo \"arg1=$1 arg2=$2 all=$@\""
description = "Test that task args are passed correctly"

[[tasks]]
name = "clone-test-repo"
command = "git clone https://github.com/nikivdev/flow-testing testing/flow-testing"
description = "Clone the flow-testing repo into testing/"

[storage]
provider = "1focus.ai"
env_var = "FLOW_SECRETS_TOKEN" # optional; defaults to this value

[[storage.envs]]
name = "local"
description = "Local development defaults"
variables = [
  { key = "DATABASE_URL", default = "" },
  { key = "OPENAI_API_KEY", default = "" },
  { key = "ANTHROPIC_API_KEY", default = "" },
]
